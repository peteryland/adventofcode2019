#include "intcode.h"

#define NUMPERMS 120
int perms[120][5] = {
  {5,6,7,8,9} ,{6,5,7,8,9} ,{7,6,5,8,9} ,{6,7,5,8,9} ,{7,5,6,8,9} ,{5,7,6,8,9} ,{8,7,6,5,9} ,{7,8,6,5,9},
  {7,6,8,5,9} ,{8,6,7,5,9} ,{6,8,7,5,9} ,{6,7,8,5,9} ,{8,5,6,7,9} ,{5,8,6,7,9} ,{5,6,8,7,9} ,{8,6,5,7,9},
  {6,8,5,7,9} ,{6,5,8,7,9} ,{8,5,7,6,9} ,{5,8,7,6,9} ,{5,7,8,6,9} ,{8,7,5,6,9} ,{7,8,5,6,9} ,{7,5,8,6,9},
  {9,8,7,6,5} ,{8,9,7,6,5} ,{8,7,9,6,5} ,{8,7,6,9,5} ,{9,7,8,6,5} ,{7,9,8,6,5} ,{7,8,9,6,5} ,{7,8,6,9,5},
  {9,6,7,8,5} ,{6,9,7,8,5} ,{6,7,9,8,5} ,{6,7,8,9,5} ,{9,7,6,8,5} ,{7,9,6,8,5} ,{7,6,9,8,5} ,{7,6,8,9,5},
  {9,6,8,7,5} ,{6,9,8,7,5} ,{6,8,9,7,5} ,{6,8,7,9,5} ,{9,8,6,7,5} ,{8,9,6,7,5} ,{8,6,9,7,5} ,{8,6,7,9,5},
  {9,5,6,7,8} ,{5,9,6,7,8} ,{5,6,9,7,8} ,{5,6,7,9,8} ,{9,6,5,7,8} ,{6,9,5,7,8} ,{6,5,9,7,8} ,{6,5,7,9,8},
  {9,6,7,5,8} ,{6,9,7,5,8} ,{6,7,9,5,8} ,{6,7,5,9,8} ,{9,5,7,6,8} ,{5,9,7,6,8} ,{5,7,9,6,8} ,{5,7,6,9,8},
  {9,7,5,6,8} ,{7,9,5,6,8} ,{7,5,9,6,8} ,{7,5,6,9,8} ,{9,7,6,5,8} ,{7,9,6,5,8} ,{7,6,9,5,8} ,{7,6,5,9,8},
  {9,5,8,7,6} ,{5,9,8,7,6} ,{5,8,9,7,6} ,{5,8,7,9,6} ,{9,8,5,7,6} ,{8,9,5,7,6} ,{8,5,9,7,6} ,{8,5,7,9,6},
  {9,8,7,5,6} ,{8,9,7,5,6} ,{8,7,9,5,6} ,{8,7,5,9,6} ,{9,5,7,8,6} ,{5,9,7,8,6} ,{5,7,9,8,6} ,{5,7,8,9,6},
  {9,7,5,8,6} ,{7,9,5,8,6} ,{7,5,9,8,6} ,{7,5,8,9,6} ,{9,7,8,5,6} ,{7,9,8,5,6} ,{7,8,9,5,6} ,{7,8,5,9,6},
  {9,5,8,6,7} ,{5,9,8,6,7} ,{5,8,9,6,7} ,{5,8,6,9,7} ,{9,8,5,6,7} ,{8,9,5,6,7} ,{8,5,9,6,7} ,{8,5,6,9,7},
  {9,8,6,5,7} ,{8,9,6,5,7} ,{8,6,9,5,7} ,{8,6,5,9,7} ,{9,5,6,8,7} ,{5,9,6,8,7} ,{5,6,9,8,7} ,{5,6,8,9,7},
  {9,6,5,8,7} ,{6,9,5,8,7} ,{6,5,9,8,7} ,{6,5,8,9,7} ,{9,6,8,5,7} ,{6,9,8,5,7} ,{6,8,9,5,7} ,{6,8,5,9,7}
};

int tryperm(word *a, size_t len, int *ps) {
  state *states[] = {0, 0, 0, 0, 0};
  int i = 0;
  word x = 0;

  for (int i = 0;; i = (i + 1) % 5) {
    if (states[i] == 0) {
      word xs[] = {ps[i], x};
      states[i] = runcode_new(a, len, xs);
    } else {
      states[i] = resume(states[i], &x);
    }
    if (states[i] == 0) {
      return x;
    }
    x = states[i]->output;
  }
}

int main() {
  word *a;
  size_t len = readprogs(&a);
  int maxval = 0;

  for (int i = 0; i < NUMPERMS; i++) {
    int *ps = perms[i];
    int val = tryperm(a, len, ps);
    if (val > maxval)
      maxval = val;
  }
  printf("%d\n", maxval);
}
